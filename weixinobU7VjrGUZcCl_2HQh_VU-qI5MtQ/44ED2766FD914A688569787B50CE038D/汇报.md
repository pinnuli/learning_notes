### 需求
#### 功能需求
- （必做）普通⻓链接⽣成7位短链接（即不管多⻓的链接，都转换成http://t.cn/{7位}格式短链）接⼝
- （必做）短链接可解析成⻓链接，⽐如浏览器请求短链，⽐如http://t.cn/RchnNi2，能跳转到对应的⻓链
- （必做）对⻓链接转换短链接的接⼝进⾏鉴权，避免恶意调⽤。
- （必做）实现接⼊⽅⿊名单功能，对在⿊名单中的接⼊⽅不提供⻓链接转短链接服务。
- （选做）后台统计功能。
    - 整个短链服务在指定时间段内／全部的⽣成短链数量（⼩时／天／⽉／纬度）
    - 各个接⼊⽅在指定时间段内／全部的⽣成短链数量、各个短链解析访问数量（⼩时／天／⽉／纬度）

#### 技术要求
- git代码管理
- maven进⾏包管理并且实现不同环境配置的管理
- 关键⽇志打印（slf4j+log4j或者slf4j+logback）
- 使⽤redis进⾏缓存，提升接⼝响应速度
- 使⽤restful⻛格
- 数据库使⽤mysql，注意索引使⽤
- 需要编写对应的单元测试


---

### ADMEMS矩阵
<table>
    <tr>
        <td>相关方</td>
        <td>功能</td>
        <td>质量</td>
        <td>约束</td>
    </tr>
    <tr>
        <td>业务级需求</td>
        <td>短链接服务</td>
        <td>----</td>
        <td>
            时间约束：一周
        </td>
    </tr>
    <tr>
        <td>用户级需求</td>
        <td>
        普通用户：
            <ul>
                <li>长链接转换为短链接</li>
                <li>访问短链接跳转到长链接</li>
            </ul>
        系统：
            <ul>
                <li>统计指定时间段内／全部的⽣成短链数量</li>
                <li>统计各个接⼊⽅在指定时间段内／全部的⽣成短链数量、各个短链解析访问数量</li>
            </ul>
        </td>
        <td>
            <ul>
                <li>安全性：避免接口被恶意调用</li>
                <li>高性能：需要保证较快的响应速度</li>
                <li>可用性：保证系统持续可用</li>
            </ul>
        </td>
        <td>
            <ul>
                <li>懂web知识的用户可能会恶意调用</li>
            </ul>
        </td>
    </tr>
    <tr>
        <td>开发级需求</td>
        <td>
            <ul>
                <li>需要对用户身份进行校验，包括token校验和黑名单</li>
            </ul>
        </td>
        <td>
            <ul>
                <li>易维护性</li>
            </ul>
        </td>
        <td>
            <ul>
                <li>技术团队：只有一人</li>
                <li>技术选用：时间紧迫只能选用熟悉的技术</li>
                <li>开发人员缺少经验</li>
            </ul>
        </td>
    </tr>
</table>

#### 关键功能
- 长链接转换为短链接
- 访问短链接跳转到长链接

#### 关键质量
- 高性能
- 可用性
- 安全性

---

### 关键功能时序图

#### 长链接生成短链接

```
sequenceDiagram
User->>ShortUrlService: longUrl
ShortUrlService->>ShortUrlService: 生成随机shortUrl
ShortUrlService->>DB: 保存到数据库
ShortUrlService->>Redis: 保存到redis
ShortUrlService-->>User: shortUrl
```

#### 访问短链接跳转到长链接

```
sequenceDiagram
User->>ShortUrlService: shortUrl
ShortUrlService->>Redis: 获取对应longUrl
ShortUrlService-->>User: 重定向到longUrl
```

---

### 7位长度，随机唯一字符串

### 使用唯一id，将id转换为62位进制（26大写字母 + 26小写字母 + 10个数字）
为了避免暴露id和保证随机性，需要将id的二进制形式在指定位插入随机的0或1，进行混淆
#### 生成唯一id的方法
#### 数据库自增id

- 优点：

    - 简单
    - 可靠性高，可以保证id有序自增且唯一
    
- 缺点：
    - 需要读写数据库


#### 使用UUID
- 优点：
    - 本地生成id，高效

- 缺点：
    - UUID过长
    - 不灵活，位数固定


#### 使用时间戳
n bit 作为毫秒数， m bit 作为统一毫秒数的序列号，防止同一毫秒内有多个请求

- 优点：
    - 本地生成id，高效
    - 灵活，可以根据需要调整id长度

- 缺点：
    - 若服务器时间回拨，可能生成重复id
    - 若使用率低，会造成id的浪费
> 7位字符串，7位62进制相当于41位二进制，假设排除需要插入混淆的3位二进制，那么支持38位的二进制，若3位作为序列号，那么剩下的35位毫秒数只能支持半年。

#### 随机生成字符串，建立唯一索引
- 优点：
    - 简单高效
    - 位数灵活
- 缺点：
    - 具有不确定性，有可能发生碰撞

> 7位字符可以组成3万多亿个字符串，假设现在有1亿的数据，新生成的id发生碰撞的概率也有有3万多分之一，概率还是很低的。


### 问题
- 缓存击穿策略
- 代码职责
- 短链预生成